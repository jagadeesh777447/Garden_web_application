trigger:
  branches:
    include:
      - main

pool:
  name: mycomputeragent

variables:
  nodeVersion: '18.x'
  buildOutput: 'dist'
  artifactName: 'angular-drop'

# ================= BUILD STAGE =================
stages:
- stage: Build
  displayName: Build Angular App
  jobs:
  - job: BuildJob
    displayName: Angular Build
    steps:

    - task: NodeTool@0
      displayName: Install Node.js
      inputs:
        versionSpec: '$(nodeVersion)'

    - script: |
        npm install
      displayName: Install dependencies

    - script: |
        npm run build
      displayName: Build Angular App

    - task: CopyFiles@2
      displayName: Copy dist files
      inputs:
        SourceFolder: '$(buildOutput)'
        Contents: '**'
        TargetFolder: '$(Build.ArtifactStagingDirectory)'

    - task: PublishPipelineArtifact@1
      displayName: Publish Artifact
      inputs:
        targetPath: '$(Build.ArtifactStagingDirectory)'
        artifact: $(artifactName)

# ================= DEPLOY TO STAGING =================
- stage: Deploy_Staging
  displayName: Deploy to Staging
  dependsOn: Build
  jobs:
  - job: DeployStaging
    displayName: Deploy Angular to Staging Slot
    steps:

    - download: current
      artifact: $(artifactName)

    - task: AzureWebApp@1
      displayName: Deploy to STAGING slot
      inputs:
        azureSubscription: AzureServiceConnection
        appType: webApp
        appName: GardenApp
        slotName: staging
        package: '$(Pipeline.Workspace)/$(artifactName)/**'

# ================= DEPLOY TO PRODUCTION (APPROVAL) =================
- stage: Deploy_Production
  displayName: Deploy to Production
  dependsOn: Deploy_Staging

  jobs:
  - deployment: SwapSlots
    displayName: Swap Staging to Production
    environment: production   # üîê APPROVAL REQUIRED HERE

    strategy:
      runOnce:
        deploy:
          steps:
          - task: AzureAppServiceManage@0
            displayName: Swap Staging to Production
            inputs:
              azureSubscription: AzureServiceConnection
              resourceGroupName: GardenApp_group-972c
              action: Swap Slots
              webAppName: GardenApp
              sourceSlot: staging
              targetSlot: production
