trigger:
  branches:
    include:
      - main

pool:
  name: mycomputeragent

variables:
  nodeVersion: '18.x'
  artifactName: 'angular-drop'

stages:

# ================= TEST STAGE =================
- stage: Test
  displayName: Run Unit Tests
  jobs:
  - job: TestJob
    displayName: Angular Unit Tests
    steps:

    - task: NodeTool@0
      displayName: Install Node.js
      inputs:
        versionSpec: '$(nodeVersion)'

    - script: npm install
      displayName: Install dependencies

    - script: npm run test -- --watch=false --browsers=ChromeHeadless
      displayName: Run Angular Unit Tests


# ================= BUILD STAGE =================
- stage: Build
  displayName: Build Angular App
  dependsOn: Test
  condition: succeeded()
  jobs:
  - job: BuildJob
    displayName: Angular Build
    steps:

    - task: NodeTool@0
      displayName: Install Node.js
      inputs:
        versionSpec: '$(nodeVersion)'

    - script: npm install
      displayName: Install dependencies

    - script: npm run build
      displayName: Build Angular App

    - task: CopyFiles@2
      displayName: Copy Angular build output
      inputs:
        SourceFolder: 'dist/client'
        Contents: '**'
        TargetFolder: '$(Build.ArtifactStagingDirectory)/site/wwwroot'

    - task: ArchiveFiles@2
      displayName: Zip Angular files
      inputs:
        rootFolderOrFile: '$(Build.ArtifactStagingDirectory)/site/wwwroot'
        includeRootFolder: false
        archiveType: zip
        archiveFile: '$(Build.ArtifactStagingDirectory)/angular.zip'
        replaceExistingArchive: true

    - task: PublishPipelineArtifact@1
      displayName: Publish Angular Artifact
      inputs:
        targetPath: '$(Build.ArtifactStagingDirectory)/angular.zip'
        artifact: $(artifactName)


# ================= DEPLOY TO STAGING =================
- stage: Deploy_Staging
  displayName: Deploy Angular to Staging
  dependsOn: Build
  condition: succeeded()
  jobs:
  - job: DeployStaging
    displayName: Deploy to Staging Slot
    steps:

    - download: current
      artifact: angular-drop

    - task: AzureWebApp@1
      displayName: Deploy Angular to STAGING slot
      inputs:
        azureSubscription: AzureServiceConnection
        appType: webApp
        appName: gardenAngular
        slotName: staging
        package: '$(Pipeline.Workspace)/angular-drop/angular.zip'


# ================= DEPLOY TO PRODUCTION =================
- stage: Deploy_Production
  displayName: Deploy to Production
  dependsOn: Deploy_Staging
  condition: succeeded()
  jobs:
  - deployment: SwapSlots
    displayName: Swap Staging to Production
    environment: production   # üîê Manual approval

    strategy:
      runOnce:
        deploy:
          steps:
          - task: AzureAppServiceManage@0
            displayName: Swap Staging to Production
            inputs:
              azureSubscription: AzureServiceConnection
              resourceGroupName: gardenangular_group
              action: Swap Slots
              webAppName: gardenAngular
              sourceSlot: staging
              targetSlot: production
