trigger:
  branches:
    include:
      - main

pool:
  name: mycomputeragent

variables:
  nodeVersion: '18.x'
  artifactName: 'angular-drop'

# ================= BUILD STAGE =================
stages:
- stage: Build
  displayName: Build Angular App
  jobs:
  - job: BuildJob
    displayName: Angular Build
    steps:

    - task: NodeTool@0
      displayName: Install Node.js
      inputs:
        versionSpec: '$(nodeVersion)'

    - script: npm install
      displayName: Install dependencies

    - script: npm run build
      displayName: Build Angular App

    # Copy ONLY dist/client (correct Angular output)
    - task: CopyFiles@2
      displayName: Copy Angular build output
      inputs:
        SourceFolder: 'dist/client'
        Contents: '**'
        TargetFolder: '$(Build.ArtifactStagingDirectory)/site/wwwroot'

    # Zip for Azure App Service (BEST PRACTICE)
    - task: ArchiveFiles@2
      displayName: Zip Angular files
      inputs:
        rootFolderOrFile: '$(Build.ArtifactStagingDirectory)/site/wwwroot'
        includeRootFolder: false
        archiveType: zip
        archiveFile: '$(Build.ArtifactStagingDirectory)/angular.zip'
        replaceExistingArchive: true

    - task: PublishPipelineArtifact@1
      displayName: Publish Angular Artifact
      inputs:
        targetPath: '$(Build.ArtifactStagingDirectory)/angular.zip'
        artifact: $(artifactName)

# ================= DEPLOY TO STAGING =================
- stage: Deploy_Staging
  displayName: Deploy Angular to Staging
  dependsOn: Build
  jobs:
  - job: DeployStaging
    displayName: Deploy to Staging Slot
    steps:
    - download: current
      artifact: angular-drop

    - task: AzureWebApp@1
      displayName: Deploy Angular to STAGING slot
      inputs:
        azureSubscription: AzureServiceConnection
        appType: webApp
        appName: GardenApp
        slotName: staging
        package: '$(Pipeline.Workspace)/angular-drop/angular.zip'

# ================= DEPLOY TO PRODUCTION (APPROVAL + ROLLBACK SAFE) =================
- stage: Deploy_Production
  displayName: Deploy to Production
  dependsOn: Deploy_Staging

  jobs:
  - deployment: SwapSlots
    displayName: Swap Staging to Production
    environment: production   # üîê Manual approval here

    strategy:
      runOnce:
        deploy:
          steps:
          - task: AzureAppServiceManage@0
            displayName: Swap Staging to Production
            inputs:
              azureSubscription: AzureServiceConnection
              resourceGroupName: GardenApp_group-972c
              action: Swap Slots
              webAppName: GardenApp
              sourceSlot: staging
              targetSlot: production
